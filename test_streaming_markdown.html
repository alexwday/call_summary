<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Streaming Markdown Renderer</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="/static/streaming-markdown.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        h1 {
            color: #333;
        }
        
        .test-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section h2 {
            margin-top: 0;
            color: #667eea;
            font-size: 18px;
        }
        
        .test-content {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            min-height: 200px;
            font-size: 14px;
        }
        
        .test-controls {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        .status {
            margin-top: 10px;
            padding: 8px;
            background: #e7f5ff;
            border-radius: 4px;
            font-size: 13px;
            color: #0c5299;
        }
        
        .error {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .success {
            background: #d1fae5;
            color: #047857;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        
        th {
            background: #f8f9fa;
        }
        
        pre {
            background: #f6f8fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        code {
            background: rgba(0,0,0,0.05);
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .markdown-fallback {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <h1>ðŸ§ª Streaming Markdown Renderer Test Suite</h1>
    
    <div class="test-container">
        <div class="test-section">
            <h2>Test 1: Streaming Table Content</h2>
            <div id="test1-content" class="test-content"></div>
            <div class="test-controls">
                <button onclick="runTest1()">Run Test</button>
                <button onclick="clearTest('test1')">Clear</button>
            </div>
            <div id="test1-status" class="status"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 2: Code Blocks with Tables</h2>
            <div id="test2-content" class="test-content"></div>
            <div class="test-controls">
                <button onclick="runTest2()">Run Test</button>
                <button onclick="clearTest('test2')">Clear</button>
            </div>
            <div id="test2-status" class="status"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 3: Incomplete Structures</h2>
            <div id="test3-content" class="test-content"></div>
            <div class="test-controls">
                <button onclick="runTest3()">Run Test</button>
                <button onclick="clearTest('test3')">Clear</button>
            </div>
            <div id="test3-status" class="status"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 4: Mixed Content</h2>
            <div id="test4-content" class="test-content"></div>
            <div class="test-controls">
                <button onclick="runTest4()">Run Test</button>
                <button onclick="clearTest('test4')">Clear</button>
            </div>
            <div id="test4-status" class="status"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 5: Edge Cases</h2>
            <div id="test5-content" class="test-content"></div>
            <div class="test-controls">
                <button onclick="runTest5()">Run Test</button>
                <button onclick="clearTest('test5')">Clear</button>
            </div>
            <div id="test5-status" class="status"></div>
        </div>
        
        <div class="test-section">
            <h2>Test 6: Performance Test</h2>
            <div id="test6-content" class="test-content"></div>
            <div class="test-controls">
                <button onclick="runTest6()">Run Test</button>
                <button onclick="clearTest('test6')">Clear</button>
            </div>
            <div id="test6-status" class="status"></div>
        </div>
    </div>
    
    <script>
        // Initialize renderer
        const renderer = new StreamingMarkdownRenderer();
        
        function clearTest(testId) {
            document.getElementById(`${testId}-content`).innerHTML = '';
            document.getElementById(`${testId}-status`).innerHTML = '';
        }
        
        // Test 1: Streaming Table Content
        async function runTest1() {
            const content = `Here is a table of data:

| Name | Age | City |
|------|-----|------|
| John | 25 | NYC |
| Jane | 30 | LA |
| Bob | 35 | Chicago |

This is after the table.`;
            
            const element = document.getElementById('test1-content');
            const status = document.getElementById('test1-status');
            status.className = 'status';
            status.textContent = 'Streaming content...';
            
            let accumulated = '';
            for (let i = 0; i < content.length; i++) {
                accumulated += content[i];
                
                try {
                    renderer.processStreamingContent(accumulated, element);
                    await new Promise(resolve => setTimeout(resolve, 20));
                } catch (error) {
                    status.className = 'status error';
                    status.textContent = `Error at position ${i}: ${error.message}`;
                    return;
                }
            }
            
            // Final render
            renderer.finalRender(accumulated, element);
            status.className = 'status success';
            status.textContent = 'âœ“ Test completed successfully';
        }
        
        // Test 2: Code Blocks with Tables
        async function runTest2() {
            const content = `## Code Example

\`\`\`python
def process_data():
    # This has a | pipe character
    result = value | mask
    return result
\`\`\`

And a table:

| Column 1 | Column 2 |
|----------|----------|
| Data 1 | Data 2 |`;
            
            const element = document.getElementById('test2-content');
            const status = document.getElementById('test2-status');
            status.className = 'status';
            status.textContent = 'Streaming content...';
            
            let accumulated = '';
            for (let i = 0; i < content.length; i++) {
                accumulated += content[i];
                
                try {
                    renderer.processStreamingContent(accumulated, element);
                    await new Promise(resolve => setTimeout(resolve, 10));
                } catch (error) {
                    status.className = 'status error';
                    status.textContent = `Error at position ${i}: ${error.message}`;
                    return;
                }
            }
            
            renderer.finalRender(accumulated, element);
            status.className = 'status success';
            status.textContent = 'âœ“ Test completed successfully';
        }
        
        // Test 3: Incomplete Structures (should not freeze)
        async function runTest3() {
            const testCases = [
                '| Header 1 | Header 2 | Header 3 |',
                '| Header 1 | Header 2 | Header 3 |\n|',
                '| Header 1 | Header 2 | Header 3 |\n|---|',
                '| Header 1 | Header 2 | Header 3 |\n|---|---|',
                '```python\ndef test():\n    return |'
            ];
            
            const element = document.getElementById('test3-content');
            const status = document.getElementById('test3-status');
            status.className = 'status';
            
            for (let i = 0; i < testCases.length; i++) {
                status.textContent = `Testing case ${i + 1}/${testCases.length}...`;
                
                const startTime = performance.now();
                try {
                    renderer.processStreamingContent(testCases[i], element);
                    const elapsed = performance.now() - startTime;
                    
                    if (elapsed > 100) {
                        status.className = 'status error';
                        status.textContent = `Case ${i + 1} took too long: ${elapsed}ms`;
                        return;
                    }
                } catch (error) {
                    status.className = 'status error';
                    status.textContent = `Error in case ${i + 1}: ${error.message}`;
                    return;
                }
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            status.className = 'status success';
            status.textContent = 'âœ“ All incomplete structure tests passed';
        }
        
        // Test 4: Mixed Content
        async function runTest4() {
            const content = `# Mixed Content Test

This is a paragraph with **bold** and *italic* text.

- List item 1
- List item 2
  - Nested item
- List item 3

> This is a blockquote
> with multiple lines

| Feature | Status |
|---------|--------|
| Tables | âœ“ Working |
| Lists | âœ“ Working |
| Code | âœ“ Working |

\`\`\`javascript
function test() {
    console.log("Hello World");
}
\`\`\`

Final paragraph.`;
            
            const element = document.getElementById('test4-content');
            const status = document.getElementById('test4-status');
            status.className = 'status';
            status.textContent = 'Streaming mixed content...';
            
            let accumulated = '';
            for (let i = 0; i < content.length; i += 5) {
                accumulated += content.slice(i, i + 5);
                
                try {
                    renderer.processStreamingContent(accumulated, element);
                    await new Promise(resolve => setTimeout(resolve, 5));
                } catch (error) {
                    status.className = 'status error';
                    status.textContent = `Error at position ${i}: ${error.message}`;
                    return;
                }
            }
            
            renderer.finalRender(accumulated, element);
            status.className = 'status success';
            status.textContent = 'âœ“ Mixed content test completed';
        }
        
        // Test 5: Edge Cases
        async function runTest5() {
            const edgeCases = [
                '|||',
                '| | | |',
                '|',
                '```',
                '```\n',
                '- ',
                '1. ',
                '**',
                '**bold**normal**bold**',
                '| Col1 | Col2 |\n|---|---|\n| | |'
            ];
            
            const element = document.getElementById('test5-content');
            const status = document.getElementById('test5-status');
            status.className = 'status';
            
            let allPassed = true;
            for (let i = 0; i < edgeCases.length; i++) {
                status.textContent = `Testing edge case ${i + 1}/${edgeCases.length}...`;
                
                try {
                    const startTime = performance.now();
                    renderer.processStreamingContent(edgeCases[i], element);
                    const elapsed = performance.now() - startTime;
                    
                    if (elapsed > 100) {
                        element.innerHTML += `<div>Case ${i + 1}: "${edgeCases[i]}" - SLOW (${elapsed}ms)</div>`;
                        allPassed = false;
                    } else {
                        element.innerHTML += `<div>Case ${i + 1}: "${edgeCases[i]}" - OK (${elapsed.toFixed(2)}ms)</div>`;
                    }
                } catch (error) {
                    element.innerHTML += `<div>Case ${i + 1}: "${edgeCases[i]}" - ERROR: ${error.message}</div>`;
                    allPassed = false;
                }
            }
            
            if (allPassed) {
                status.className = 'status success';
                status.textContent = 'âœ“ All edge cases handled correctly';
            } else {
                status.className = 'status error';
                status.textContent = 'âš  Some edge cases had issues';
            }
        }
        
        // Test 6: Performance Test
        async function runTest6() {
            const element = document.getElementById('test6-content');
            const status = document.getElementById('test6-status');
            status.className = 'status';
            status.textContent = 'Running performance test...';
            
            // Generate a large table
            let content = '# Performance Test\n\n| ID | Name | Description | Status | Date |\n|---|---|---|---|---|\n';
            for (let i = 1; i <= 50; i++) {
                content += `| ${i} | Item ${i} | This is a description for item ${i} | Active | 2024-01-${String(i % 30 + 1).padStart(2, '0')} |\n`;
            }
            
            const startTime = performance.now();
            let accumulated = '';
            let maxChunkTime = 0;
            
            // Simulate streaming
            for (let i = 0; i < content.length; i += 10) {
                accumulated += content.slice(i, Math.min(i + 10, content.length));
                
                const chunkStart = performance.now();
                try {
                    renderer.processStreamingContent(accumulated, element);
                } catch (error) {
                    status.className = 'status error';
                    status.textContent = `Error: ${error.message}`;
                    return;
                }
                const chunkTime = performance.now() - chunkStart;
                maxChunkTime = Math.max(maxChunkTime, chunkTime);
                
                if (chunkTime > 100) {
                    status.className = 'status error';
                    status.textContent = `Rendering too slow at position ${i}: ${chunkTime}ms`;
                    return;
                }
            }
            
            // Final render
            renderer.finalRender(accumulated, element);
            
            const totalTime = performance.now() - startTime;
            status.className = 'status success';
            status.textContent = `âœ“ Performance test completed in ${totalTime.toFixed(2)}ms (max chunk: ${maxChunkTime.toFixed(2)}ms)`;
        }
        
        // Run all tests button
        async function runAllTests() {
            const tests = [runTest1, runTest2, runTest3, runTest4, runTest5, runTest6];
            for (const test of tests) {
                await test();
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }
    </script>
    
    <div style="text-align: center; margin-top: 30px;">
        <button onclick="runAllTests()" style="padding: 12px 24px; font-size: 16px;">
            ðŸš€ Run All Tests
        </button>
    </div>
</body>
</html>